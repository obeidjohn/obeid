!function(f){var d,u=f(window);String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)};e=document.createElement("canvas"),t=(t=e.getContext("webgl")||e.getContext("experimental-webgl"))&&t.getExtension("OES_texture_float")&&t.getExtension("OES_texture_float_linear"),e.remove();var e,t,i=t;function r(e,t){function r(e,t){e=d.createShader(e);if(d.shaderSource(e,t),d.compileShader(e),d.getShaderParameter(e,d.COMPILE_STATUS))return e;throw new Error("compile error: "+d.getShaderInfoLog(e))}var o={};if(o.id=d.createProgram(),d.attachShader(o.id,r(d.VERTEX_SHADER,e)),d.attachShader(o.id,r(d.FRAGMENT_SHADER,t)),d.linkProgram(o.id),!d.getProgramParameter(o.id,d.LINK_STATUS))throw new Error("link error: "+d.getProgramInfoLog(o.id));o.uniforms={},o.locations={},d.useProgram(o.id),d.enableVertexAttribArray(0);for(var i,a=/uniform (\w+) (\w+)/g,n=e+t;null!=(match=a.exec(n));)i=match[2],o.locations[i]=d.getUniformLocation(o.id,i);return o}function n(e,t){d.activeTexture(d.TEXTURE0+(t||0)),d.bindTexture(d.TEXTURE_2D,e)}function a(e,t){var o=this,r=(this.$el=f(e),this.$el.addClass("ripples"),/url\(["']?([^"']*)["']?\)/.exec(this.$el.css("background-image"))[1]),i=(this.resolution=t.resolution||256,this.textureDelta=new Float32Array([1/this.resolution,1/this.resolution]),this.perturbance=t.perturbance,document.createElement("canvas")),a=(i.width=this.$el.outerWidth(),i.height=this.$el.outerHeight(),this.canvas=i,this.$el.append(i),this.context=d=i.getContext("webgl")||i.getContext("experimental-webgl"),d.getExtension("OES_texture_float"),d.getExtension("OES_texture_float_linear"),f(window).on("resize",function(){o.$el.outerWidth()==o.canvas.width&&o.$el.outerHeight()==o.canvas.height||(i.width=o.$el.outerWidth(),i.height=o.$el.outerHeight())}),this.$el.on("mousemove",f.proxy(this.mousemove,this)),this.$el.on("mousemoverel",f.proxy(this.mousemove,this)),this.$el.on("mousedown",f.proxy(this.mousedown,this)),new Image);a.crossOrigin="",a.onload=function(){function e(e){return 0==(e&e-1)}d=o.context;var t=e(a.width)&&e(a.height)?d.REPEAT:d.CLAMP_TO_EDGE,r=(o.backgroundWidth=a.width,o.backgroundHeight=a.height,d.createTexture());d.bindTexture(d.TEXTURE_2D,r),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,1),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,t),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,t),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,a),o.backgroundTexture=r},a.src=e.dataset.src||r,this.textures=[],this.framebuffers=[];for(var n=0;n<2;n++){var s=d.createTexture(),u=d.createFramebuffer(),h=(d.bindFramebuffer(d.FRAMEBUFFER,u),u.width=this.resolution,u.height=this.resolution,d.bindTexture(d.TEXTURE_2D,s),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,this.resolution,this.resolution,0,d.RGBA,d.FLOAT,null),d.createRenderbuffer());if(d.bindRenderbuffer(d.RENDERBUFFER,h),d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,this.resolution,this.resolution),d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,s,0),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,h),d.checkFramebufferStatus(d.FRAMEBUFFER)!=d.FRAMEBUFFER_COMPLETE)throw new Error("Rendering to this texture is not supported (incomplete framebuffer)");d.bindTexture(d.TEXTURE_2D,null),d.bindRenderbuffer(d.RENDERBUFFER,null),d.bindFramebuffer(d.FRAMEBUFFER,null),this.textures.push(s),this.framebuffers.push(u)}this.quad=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,this.quad),d.bufferData(d.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),d.STATIC_DRAW),this.initShaders(),requestAnimationFrame(function e(){o.update(),requestAnimationFrame(e)})}a.DEFAULTS={resolution:256,perturbance:.03},a.prototype={update:function(){d=this.context,this.backgroundTexture&&(this.updateTextures(),this.render())},drawQuad:function(){d.bindBuffer(d.ARRAY_BUFFER,this.quad),d.vertexAttribPointer(0,2,d.FLOAT,!1,0,0),d.drawArrays(d.TRIANGLE_FAN,0,4)},render:function(){d.viewport(0,0,this.canvas.width,this.canvas.height),d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT),d.useProgram(this.renderProgram.id),n(this.backgroundTexture,0),n(this.textures[0],1),d.uniform2fv(this.renderProgram.locations.topLeft,this.renderProgram.uniforms.topLeft),d.uniform2fv(this.renderProgram.locations.bottomRight,this.renderProgram.uniforms.bottomRight),d.uniform2fv(this.renderProgram.locations.containerRatio,this.renderProgram.uniforms.containerRatio),d.uniform1i(this.renderProgram.locations.samplerBackground,0),d.uniform1i(this.renderProgram.locations.samplerRipples,1),this.drawQuad()},updateTextures:function(){this.computeTextureBoundaries(),d.viewport(0,0,this.resolution,this.resolution);for(var e=0;e<2;e++)d.bindFramebuffer(d.FRAMEBUFFER,this.framebuffers[e]),n(this.textures[1-e]),d.useProgram(this.updateProgram[e].id),this.drawQuad();d.bindFramebuffer(d.FRAMEBUFFER,null)},computeTextureBoundaries:function(){var e,t,r=this.$el.css("background-size"),o=this.$el.css("background-attachment"),i=this.$el.css("background-position").split(" "),o="fixed"==o?u:this.$el,a=o.offset()||{left:pageXOffset,top:pageYOffset},n=o.outerWidth(),o=o.outerHeight(),s=(t="cover"==r?(s=Math.max(n/this.backgroundWidth,o/this.backgroundHeight),e=this.backgroundWidth*s,this.backgroundHeight*s):"contain"==r?(s=Math.min(n/this.backgroundWidth,o/this.backgroundHeight),e=this.backgroundWidth*s,this.backgroundHeight*s):(e=(r=r.split(" "))[0],t=r[1]||r[0],e=e.endsWith("%")?n*parseFloat(e)/100:"auto"==e?this.backgroundWidth:parseFloat(e),t.endsWith("%")?o*parseFloat(t)/100:"auto"==t?this.backgroundHeight:parseFloat(t)),i[0]),r=i[1],s="left"==s?a.left:"center"==s?a.left+n/2-e/2:"right"==s?a.left+n-e:s.endsWith("%")?a.left+(n-e)*parseFloat(s)/100:parseFloat(s),r="top"==r?a.top:"center"==r?a.top+o/2-t/2:"bottom"==r?a.top+o-t:r.endsWith("%")?a.top+(o-t)*parseFloat(r)/100:parseFloat(r),i=this.$el.offset(),n=(this.renderProgram.uniforms.topLeft=new Float32Array([(i.left-s)/e,(i.top-r)/t]),this.renderProgram.uniforms.bottomRight=new Float32Array([this.renderProgram.uniforms.topLeft[0]+this.$el.outerWidth()/e,this.renderProgram.uniforms.topLeft[1]+this.$el.outerHeight()/t]),Math.max(this.canvas.width,this.canvas.height));this.renderProgram.uniforms.containerRatio=new Float32Array([this.canvas.width/n,this.canvas.height/n])},initShaders:function(){var e=["attribute vec2 vertex;","varying vec2 coord;","void main() {","coord = vertex * 0.5 + 0.5;","gl_Position = vec4(vertex, 0.0, 1.0);","}"].join("\n");this.dropProgram=r(e,["precision highp float;","const float PI = 3.141592653589793;","uniform sampler2D texture;","uniform vec2 center;","uniform float radius;","uniform float strength;","varying vec2 coord;","void main() {","vec4 info = texture2D(texture, coord);","float drop = max(0.0, 1.0 - length(center * 0.5 + 0.5 - coord) / radius);","drop = 0.5 - cos(drop * PI) * 0.5;","info.r += drop * strength;","gl_FragColor = info;","}"].join("\n")),this.updateProgram=[0,0],this.updateProgram[0]=r(e,["precision highp float;","uniform sampler2D texture;","uniform vec2 delta;","varying vec2 coord;","void main() {","vec4 info = texture2D(texture, coord);","vec2 dx = vec2(delta.x, 0.0);","vec2 dy = vec2(0.0, delta.y);","float average = (","texture2D(texture, coord - dx).r +","texture2D(texture, coord - dy).r +","texture2D(texture, coord + dx).r +","texture2D(texture, coord + dy).r",") * 0.25;","info.g += (average - info.r) * 2.0;","info.g *= 0.995;","info.r += info.g;","gl_FragColor = info;","}"].join("\n")),d.uniform2fv(this.updateProgram[0].locations.delta,this.textureDelta),this.updateProgram[1]=r(e,["precision highp float;","uniform sampler2D texture;","uniform vec2 delta;","varying vec2 coord;","void main() {","vec4 info = texture2D(texture, coord);","vec3 dx = vec3(delta.x, texture2D(texture, vec2(coord.x + delta.x, coord.y)).r - info.r, 0.0);","vec3 dy = vec3(0.0, texture2D(texture, vec2(coord.x, coord.y + delta.y)).r - info.r, delta.y);","info.ba = normalize(cross(dy, dx)).xz;","gl_FragColor = info;","}"].join("\n")),d.uniform2fv(this.updateProgram[1].locations.delta,this.textureDelta),this.renderProgram=r(["precision highp float;","attribute vec2 vertex;","uniform vec2 topLeft;","uniform vec2 bottomRight;","uniform vec2 containerRatio;","varying vec2 ripplesCoord;","varying vec2 backgroundCoord;","void main() {","backgroundCoord = mix(topLeft, bottomRight, vertex * 0.5 + 0.5);","backgroundCoord.y = 1.0 - backgroundCoord.y;","ripplesCoord = vec2(vertex.x, -vertex.y) * containerRatio * 0.5 + 0.5;","gl_Position = vec4(vertex.x, -vertex.y, 0.0, 1.0);","}"].join("\n"),["precision highp float;","uniform sampler2D samplerBackground;","uniform sampler2D samplerRipples;","uniform float perturbance;","varying vec2 ripplesCoord;","varying vec2 backgroundCoord;","void main() {","vec2 offset = -texture2D(samplerRipples, ripplesCoord).ba;","float specular = pow(max(0.0, dot(offset, normalize(vec2(-0.6, 1.0)))), 4.0);","gl_FragColor = texture2D(samplerBackground, backgroundCoord + offset * perturbance) + specular;","}"].join("\n")),d.uniform1f(this.renderProgram.locations.perturbance,this.perturbance)},dropAtMouse:function(e,t,r){d=this.context,e.offsetX=e.offsetX||e.pageX-this.$el.offset().left,e.offsetY=e.offsetY||e.pageY-this.$el.offset().top;var o=this.$el.outerWidth(),i=this.$el.outerHeight(),a=Math.max(o,i),o=new Float32Array([(2*e.offsetX-o)/a,(i-2*e.offsetY)/a]),i=(d.viewport(0,0,this.resolution,this.resolution),d.bindFramebuffer(d.FRAMEBUFFER,this.framebuffers[0]),n(this.textures[1]),d.useProgram(this.dropProgram.id),d.uniform2fv(this.dropProgram.locations.center,o),d.uniform1f(this.dropProgram.locations.radius,t),d.uniform1f(this.dropProgram.locations.strength,r),this.drawQuad(),this.framebuffers[0]);this.framebuffers[0]=this.framebuffers[1],this.framebuffers[1]=i,i=this.textures[0],this.textures[0]=this.textures[1],this.textures[1]=i,d.bindFramebuffer(d.FRAMEBUFFER,null)},mousemove:function(e){this.dropAtMouse(e,.03,.01)},mousedown:function(e){this.dropAtMouse(e,.09,.14)}};var o=f.fn.ripples;f.fn.ripples=function(o){return this.each(function(){if(!i)throw new Error("Your browser does not support at least one of the following: WebGL, OES_texture_float extension, OES_texture_float_linear extension.");var e=f(this),t=e.data("ripples"),r=f.extend({},a.DEFAULTS,e.data(),"object"==typeof o&&o);t||e.data("ripples",new a(this,r))})},f.fn.ripples.Constructor=a,f.fn.ripples.noConflict=function(){return f.fn.ripples=o,this}}(window.jQuery);